caption: å…ƒç±» Meta Class
created: 20190720174549643
creator: liyzcj
modified: 20200404130152161
modifier: liyzcj
tags: PythonFeature Migrated
title: Python Meta Class
type: text/vnd.tiddlywiki

! å…ƒç±»

''åŠ¨æ€è¯­è¨€'' ä¸ ''é™æ€è¯­è¨€'' æœ€å¤§çš„ä¸åŒå°±æ˜¯, å‡½æ•°å’Œç±»çš„å®šä¹‰ä¸æ˜¯ç¼–è¯‘æ—¶å®šä¹‰çš„, è€Œæ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºçš„.

æ¯”å¦‚è¯´, æˆ‘ä»¬è¦å®šä¹‰ä¸€ä¸ª Hello çš„ class, å°±å†™ä¸€ä¸ª hello.py æ¨¡ç»„:

```python
class Hello(object):
  def hello(self, name='world'):
      print('Hello, %s.' % name)
```

å½“ Python è§£é‡Šå™¨è½½å…¥ hello æ¨¡ç»„çš„æ—¶å€™, å°±ä¼šä¾æ¬¡æ‰§è¡Œè¯¥æ¨¡ç»„çš„æ‰€æœ‰è¯­å¥, æ‰§è¡Œçš„ç»“æœå°±æ˜¯åŠ¨æ€åˆ›å»ºå‡ºä¸€ä¸ª Hello çš„ class å®ä¾‹.

ç‰¹æ®Šçš„, `type()` æ–¹æ³•ä¸ä»…å¯ä»¥è¿”å›å®ä¾‹çš„ç±»å‹, è¿˜å¯ä»¥åˆ›å»ºæ–°çš„ç±». ä¾‹å¦‚, é€šè¿‡ `type()` åˆ›å»º Hello ç±»å®ä¾‹:

```python
def fn(self, name='world'): # å…ˆå®šä¹‰å‡½æ•°
  print('Hello, %s.' % name)

Hello = type('Hello', (object,), dict(hello=fn)) # åˆ›å»ºHello class
h = Hello()
h.hello()
```

é™¤äº†ä½¿ç”¨ `type()` åŠ¨æ€åˆ›å»ºç±»ä»¥å¤–, è¦æ§åˆ¶ç±»çš„åˆ›å»ºè¡Œä¸º, è¿˜å¯ä»¥ä½¿ç”¨ `metaclass`.

---

;~MetaClass å…ƒç±»
:ç±»ç›¸å½“äºå…ƒç±»çš„å®ä¾‹, é¦–å…ˆåˆ›å»ºå…ƒç±», å†æ ¹æ®å…ƒç±»å®ä¾‹åŒ–ç±».

> ğŸ’¡ æŒ‰ç…§é»˜è®¤ä¹ æƒ¯, `metaclass` çš„ç±»åæ€»æ˜¯ä»¥ `Metaclass` ç»“å°¾, ä»¥ä¾¿æ¸…æ¥šçš„è¡¨è¾¾è¿™æ˜¯ä¸€ä¸ªå…ƒç±».

ä¾‹å¦‚:

```python
# metaclassæ˜¯ç±»çš„æ¨¡æ¿ï¼Œæ‰€ä»¥å¿…é¡»ä»`type`ç±»å‹æ´¾ç”Ÿï¼š
class ListMetaclass(type):
  def __new__(cls, name, bases, attrs):
    attrs['add'] = lambda self, value: self.append(value)
    return type.__new__(cls, name, bases, attrs)
```

æœ‰äº†ä»¥ä¸Š `ListMetaclass` ä»¥å, æˆ‘ä»¬åœ¨å®šä¹‰ç±»çš„æ—¶å€™è¦æŒ‡å®šç»§æ‰¿ ~ListMetaclass æ¥å®šåˆ¶ç±», ä¼ å…¥å…³é”®å­—å‚æ•° `metaclass`:

```python
class MyList(list, metaclass=ListMetaclass):
  pass
```

`__new__()` æ–¹æ³•æ¥æ”¶åˆ°çš„å‚æ•°ä¾æ¬¡ä¸º:

* å½“å‰å‡†å¤‡åˆ›å»ºçš„ç±»çš„å®ä¾‹;
* ç±»çš„åç§°;
* ç±»ç»§æ‰¿çš„çˆ¶ç±»é›†åˆ;
* ç±»çš„æ–¹æ³•é›†åˆ.